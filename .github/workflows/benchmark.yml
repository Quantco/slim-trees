name: Benchmark
on:
  push:
    branches: [main]
  pull_request:
permissions:
  pull-requests: write
  contents: read

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up conda env
        uses: mamba-org/provision-with-micromamba@v15
        with:
          cache-env: true
          extra-specs: |
            python=3.11
      - name: Install repository
        run: python -m pip install --no-build-isolation --no-deps --disable-pip-version-check -e .
      - name: Cache models
        uses: actions/cache@v3
        env:
          cache-name: benchmark-model-cache
        with:
          path: examples/benchmark_models
          key: models-${{ hashFiles('benchmark.py') }}
      - name: Run benchmark
        shell: bash -el {0}
        run: |
          echo "_(benchmark **${{ github.run_id }}** / attempt **${{ github.run_attempt }}**)_" >> benchmark.md
          python benchmark.py >> benchmark.md
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: benchmark.md
          comment_tag: benchmark
      - name: Add benchmark to Job Summary
        run: cat benchmark.md >> "$GITHUB_STEP_SUMMARY"
