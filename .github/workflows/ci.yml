name: CI
on: [push]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash -el {0}

env:
  CONDA_CHANNEL_UPLOAD_USER: ${{ secrets.CONDA_CHANNEL_UPLOAD_USER }}
  CONDA_CHANNEL_UPLOAD_PASSWORD: ${{ secrets.CONDA_CHANNEL_UPLOAD_PASSWORD }}
  CONDA_API_KEY: ${{ secrets.QUETZ_API_KEY }}

jobs:
  linux-unittests:
    name: "Unit tests - Python ${{ matrix.PYTHON_VERSION }}"
    timeout-minutes: 15
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        PYTHON_VERSION: ['3.8', '3.9', '3.10', '3.11']
    steps:
      - name: Checkout branch
        uses: actions/checkout@v3
      - name: Set up Conda env
        uses: mamba-org/provision-with-micromamba@v15
        with:
          cache-env: true
          extra-specs: |
            python=${{ matrix.PYTHON_VERSION }}
            pytest-md
            pytest-emoji
      - name: Install repository
        run: python -m pip install --no-build-isolation --no-deps --disable-pip-version-check -e .
      - name: Run unittests
        uses: pavelzw/pytest-action@v2
        with:
          report-title: "Unit tests Linux - Python ${{ matrix.PYTHON_VERSION }}"

  pre-commit:
    name: "Pre-commit checks"
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
      - name: Checkout branch
        uses: actions/checkout@v3
      - name: Set up Conda env
        uses: mamba-org/provision-with-micromamba@v15
        with:
          cache-env: true
          extra-specs: |
            python=3.11
            pre-commit
      - name: Run pre-commit checks
        run: pre-commit run --all-files
